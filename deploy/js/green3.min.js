var Cube={};Cube.core={};Cube.core.math={};Cube.core.math.Vector3=function(a,c,b){this.set(a,c,b)};Cube.core.math.Vector3.prototype={constructor:Cube.core.math.Vector3,getX:function(){return this.x},getY:function(){return this.y},getZ:function(){return this.z},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setZ:function(a){this.z=a;return this},set:function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0;return this},setFrom:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},addSelf:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},subSelf:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},scaleSelf:function(a){this.x*=a;this.y*=a;this.z*=a;return this},dot:function(a){return this.x*a.y+this.y*a.y+this.z*a.z},length:function(){return this.dot(this)},normalizeSelf:function(){return this.scaleSelf(this.length())}};Cube.core.math.Matrix4=function(){this.data=new Float32Array(16)};Cube.core.math.Matrix4.prototype={constructor:Cube.core.math.Matrix4,clone:function(){return(new Cube.core.math.Matrix4()).initFromRawData(this.data)},initToIdentity:function(){return this.initFromRawData(this.rawdata_identity)},initFromRawData:function(b){var a;for(a=0;a<16;++a){this.data[a]=b[a]}return this},getRawData:function(){return this.data},setElement:function(a,c,b){this.data[c*4+a]=b;return this},multiply:function(a){var b=this.clone();return b.multiplyToSelf(a)},invertToSelf:function(){var f=this.data;var l=f[0*4+0],j=f[1*4+0],h=f[2*4+0],g=f[3*4+0];var r=f[0*4+1],q=f[1*4+1],p=f[2*4+1],o=f[3*4+1];var e=f[0*4+2],d=f[1*4+2],c=f[2*4+2],b=f[3*4+2];var n=f[0*4+3],m=f[1*4+3],k=f[2*4+3],i=f[3*4+3];var a=this.determinant();f[0*4+0]=p*b*m-o*c*m+o*d*k-q*b*k-p*d*i+q*c*i;f[1*4+0]=g*c*m-h*b*m-g*d*k+j*b*k+h*d*i-j*c*i;f[2*4+0]=h*o*m-g*p*m+g*q*k-j*o*k-h*q*i+j*p*i;f[3*4+0]=g*p*d-h*o*d-g*q*c+j*o*c+h*q*b-j*p*b;f[0*4+1]=o*c*n-p*b*n-o*e*k+r*b*k+p*e*i-r*c*i;f[1*4+1]=h*b*n-g*c*n+g*e*k-l*b*k-h*e*i+l*c*i;f[2*4+1]=g*p*n-h*o*n-g*r*k+l*o*k+h*r*i-l*p*i;f[3*4+1]=h*o*e-g*p*e+g*r*c-l*o*c-h*r*b+l*p*b;f[0*4+2]=q*b*n-o*d*n+o*e*m-r*b*m-q*e*i+r*d*i;f[1*4+2]=g*d*n-j*b*n-g*e*m+l*b*m+j*e*i-l*d*i;f[2*4+2]=j*o*n-g*q*n+g*r*m-l*o*m-j*r*i+l*q*i;f[3*4+2]=g*q*e-j*o*e-g*r*d+l*o*d+j*r*b-l*q*b;f[0*4+3]=p*d*n-q*c*n-p*e*m+r*c*m+q*e*k-r*d*k;f[1*4+3]=j*c*n-h*d*n+h*e*m-l*c*m-j*e*k+l*d*k;f[2*4+3]=h*q*n-j*p*n-h*r*m+l*p*m+j*r*k-l*q*k;f[3*4+3]=j*p*e-h*q*e+h*r*d-l*p*d-j*r*c+l*q*c;return this.scaleToSelf(1/a)},determinant:function(){var e=this.data;var k=e[0*4+0],i=e[1*4+0],g=e[2*4+0],f=e[3*4+0];var r=e[0*4+1],q=e[1*4+1],p=e[2*4+1],o=e[3*4+1];var d=e[0*4+2],c=e[1*4+2],b=e[2*4+2],a=e[3*4+2];var m=e[0*4+3],l=e[1*4+3],j=e[2*4+3],h=e[3*4+3];var n=f*p*c*m-g*o*c*m-f*q*b*m+i*o*b*m+g*q*a*m-i*p*a*m-f*p*d*l+g*o*d*l+f*r*b*l-k*o*b*l-g*r*a*l+k*p*a*l+f*q*d*j-i*o*d*j-f*r*c*j+k*o*c*j+i*r*a*j-k*q*a*j-g*q*d*h+i*p*d*h+g*r*c*h-k*p*c*h-i*r*b*h+k*q*b*h;return n},multiplyToSelf:function(e){var k=this.data;var w=e.data;var s=k[0*4+0],r=k[1*4+0],p=k[2*4+0],n=k[3*4+0];var H=k[0*4+1],G=k[1*4+1],F=k[2*4+1],E=k[3*4+1];var h=k[0*4+2],g=k[1*4+2],f=k[2*4+2],d=k[3*4+2];var u=k[0*4+3],t=k[1*4+3],q=k[2*4+3],o=k[3*4+3];var C=w[0*4+0],A=w[1*4+0],y=w[2*4+0],v=w[3*4+0];var c=w[0*4+1],b=w[1*4+1],a=w[2*4+1],I=w[3*4+1];var m=w[0*4+2],l=w[1*4+2],j=w[2*4+2],i=w[3*4+2];var D=w[0*4+3],B=w[1*4+3],z=w[2*4+3],x=w[3*4+3];k[0*4+0]=s*C+r*c+p*m+n*D;k[1*4+0]=s*A+r*b+p*l+n*B;k[2*4+0]=s*y+r*a+p*j+n*z;k[3*4+0]=s*v+r*I+p*i+n*x;k[0*4+1]=H*C+G*c+F*m+E*D;k[1*4+1]=H*A+G*b+F*l+E*B;k[2*4+1]=H*y+G*a+F*j+E*z;k[3*4+1]=H*v+G*I+F*i+E*x;k[0*4+2]=h*C+g*c+f*m+d*D;k[1*4+2]=h*A+g*b+f*l+d*B;k[2*4+2]=h*y+g*a+f*j+d*z;k[3*4+2]=h*v+g*I+f*i+d*x;k[0*4+3]=u*C+t*c+q*m+o*D;k[1*4+3]=u*A+t*b+q*l+o*B;k[2*4+3]=u*y+t*a+q*j+o*z;k[3*4+3]=u*v+t*I+q*i+o*x;return this},scaleToSelf:function(b){var a;var c=this.data;for(a=0;a<4*4;++a){c[a]*=b}return this},transposeToSelf:function(){var b=this.data;var a;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];
b[14]=a;return this}};Cube.core.math.Matrix4.prototype.rawdata_identity=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];Cube.core.Utilities={buildName:(function(){var a=0;return function(){return"Node"+a++}})(),checkReference:function(a,b){if(!a){throw"invalid reference "+(b||"")}},checkType:function(b,a,c){if(!(b instanceof a)){throw"unexpected type "+(c||"")}}};Cube.core.Visitor=function(){this.depth=0;this.prefix=""};Cube.core.Visitor.prototype={};Cube.core.Visitor.prototype.constructor=Cube.core.Visitor;Cube.core.Visitor.prototype.visitArrayBegin=function(a){this.depth+=1;this.prefix=this.prefix.concat(" ")};Cube.core.Visitor.prototype.visitArrayEnd=function(){this.depth-=1;this.prefix=this.prefix.substr(0,this.depth)};Cube.core.Visitor.prototype.visitStatePush=function(){print(this.prefix,"PUSH")};Cube.core.Visitor.prototype.visitStatePop=function(){print(this.prefix,"POP")};Cube.core.Visitor.prototype.visitGeometry=function(a){print(this.prefix,"Geometry")};Cube.core.Visitor.prototype.visitMaterial=function(a){print(this.prefix,"Material")};Cube.core.Visitor.prototype.visitTransform=function(a){print(this.prefix,"Transform")};Cube.core.Visitor.prototype.visitTransformStack=function(a){print(this.prefix,"TransformStack")};Cube.core.Visitor.prototype.visitOptic=function(a){print(this.prefix,"Optic")};Cube.core.RenderVisitor=function(a){Cube.core.Utilities.checkType(a.renderer,Cube.core.Renderer,"attribute.renderer should be of type Cube.core.Renderer");this.renderer=a.renderer};Cube.core.RenderVisitor.prototype={};Cube.core.RenderVisitor.prototype.constructor=Cube.core.RenderVisitor;Cube.core.RenderVisitor.prototype.visitArrayBegin=function(a){};Cube.core.RenderVisitor.prototype.visitArrayEnd=function(){};Cube.core.RenderVisitor.prototype.visitViewport=function(a){this.renderer.setViewport(a.getX(),a.getY(),a.getWidth(),a.getHeight())};Cube.core.RenderVisitor.prototype.visitOptic=function(a){this.renderer.loadProjectionTransformation(a.getMatrix())};Cube.core.RenderVisitor.prototype.visitTransform=function(a){this.renderer.loadModelTransformation(a.getMatrix());this.renderer.loadNormalTransformation(a.getNormal())};Cube.core.RenderVisitor.prototype.visitView=function(a){this.renderer.loadViewTransformation(a.getInvert())};Cube.core.RenderVisitor.prototype.visitBufferSet=function(a){this.renderer.renderBufferSet(this.renderer.mode.ELEMENT,a)};Cube.core.RenderVisitor.prototype.visitShader=function(a){this.renderer.useShader(a)};Cube.core.RenderVisitor.prototype.visitTexture=function(a){this.renderer.useTexture(a)};Cube.core.RenderVisitor.prototype.visitMaterial=function(a){this.renderer.setTransparentMode(a.isTransparent())};Cube.core.RenderVisitor.prototype.visitMaterialBinding=function(c){var a=c.getParameterName();var d=c.getParameterType();var b=c.getParameterValue();this.renderer.bindShaderParamWithValue(a,d,b)};Cube.core.Node=function(a){this.name=a.name||Cube.core.Utilities.buildName()};Cube.core.Node.prototype={};Cube.core.Node.prototype.constructor=Cube.core.Node;Cube.core.Node.prototype.accept=null;Cube.core.ArrayNode=function(a){Cube.core.Node.call(this,a);this.checkNodes(a.nodes);this.nodes=a.nodes||[]};Cube.core.ArrayNode.prototype=new Cube.core.Node({});Cube.core.ArrayNode.prototype.constructor=Cube.core.ArrayNode;Cube.core.ArrayNode.prototype.accept=function(c){c.visitArrayBegin(this.nodes.length);var a;for(a=0;a<this.nodes.length;++a){var b=this.nodes[a];b.accept(c)}c.visitArrayEnd()};Cube.core.ArrayNode.prototype.push=function(a){this.checkNode(a);this.nodes.push(a)};Cube.core.ArrayNode.prototype.clear=function(a){this.nodes.splice(a);return this};Cube.core.ArrayNode.prototype.checkNode=function(a){Cube.core.Utilities.checkReference(a,"node");Cube.core.Utilities.checkType(a,Cube.core.Node,"node should be Cube.core.Node")};Cube.core.ArrayNode.prototype.checkNodes=function(a){if(!a){return}Cube.core.Utilities.checkType(a,Array,"nodes shoud be Array");var b;for(b=0;b<a.length;++b){Cube.core.Utilities.checkReference(a[b],"nodes[i]");
Cube.core.Utilities.checkType(a[b],Cube.core.Node,"nodes["+b+"] should be Cube.core.Node")}};Cube.core.BufferSetNode=function(b){this.factory=b.factory;this.vertexBuffer=null;this.normalBuffer=null;this.colorBuffer=null;this.uvBuffer=null;this.indexBuffer=null;var a=this.factory;if(!!b.vertex){this.vertexBuffer=this.buildBuffer(false,b.vertex,a)}if(!!b.normal){this.normalBuffer=this.buildBuffer(false,b.normal,a)}if(!!b.color){this.colorBuffer=this.buildBuffer(false,b.color,a)}if(!!b.uv){this.uvBuffer=this.buildBuffer(false,b.uv,a)}if(!!b.index){this.indexBuffer=this.buildBuffer(true,b.index,a)}Cube.core.Node.call(this,b)};Cube.core.BufferSetNode.prototype=new Cube.core.Node({});Cube.core.BufferSetNode.prototype.constructor=Cube.core.BufferSetNode;Cube.core.BufferSetNode.prototype.accept=function(a){a.visitBufferSet(this)};Cube.core.BufferSetNode.prototype.buildBuffer=function(b,c,a){return{size:c.length,data:a(b,c)}};Cube.core.BufferSetNode.prototype.checkFactory=function(a){Cube.core.Utilities.checkReference(a);return a};Cube.core.BufferSetNode.prototype.checkBuffer=function(a){Cube.core.Utilities.checkReference(a);return a};Cube.core.OutputToBufferSet=function(a){this.hasVertex=!!a.hasVertex;this.hasNormal=!!a.hasNormal;this.hasColor=!!a.hasColor;this.hasUV=!!a.hasUV;this.hasIndex=!!a.hasIndex;this.factory=a.factory;this.vertex=null;this.normal=null;this.color=null;this.uv=null;this.index=null};Cube.core.OutputToBufferSet.prototype={};Cube.core.OutputToBufferSet.prototype.constructor=Cube.core.OutputToBufferSet;Cube.core.OutputToBufferSet.prototype.begin=function(a,b){if(!!this.hasVertex){this.vertex=[]}if(!!this.hasNormal){this.normal=[]}if(!!this.hasColor){this.color=[]}if(!!this.hasUV){this.uv=[]}if(!!this.hasIndex){this.index=[]}};Cube.core.OutputToBufferSet.prototype.end=function(){var a={factory:this.factory};if(!!this.hasVertex){a.vertex=new Float32Array(this.vertex)}if(!!this.hasNormal){a.normal=new Float32Array(this.normal)}if(!!this.hasColor){a.color=new Float32Array(this.color)}if(!!this.hasUV){a.uv=new Float32Array(this.uv)}if(!!this.hasIndex){a.index=new Uint16Array(this.index)}return new Cube.core.BufferSetNode(a)};Cube.core.OutputToBufferSet.prototype.addVertex=function(a,c,b){if(!this.hasVertex){return}this.vertex.push(a);this.vertex.push(c);this.vertex.push(b)};Cube.core.OutputToBufferSet.prototype.addNormal=function(a,c,b){if(!this.hasNormal){return}this.normal.push(a);this.normal.push(c);this.normal.push(b)};Cube.core.OutputToBufferSet.prototype.addColor=function(f,e,c,d){if(!this.hasColor){return}this.color.push(f);this.color.push(e);this.color.push(c);this.color.push(d)};Cube.core.OutputToBufferSet.prototype.addUV=function(b,a){if(!this.hasUV){return}this.uv.push(b);this.uv.push(a)};Cube.core.OutputToBufferSet.prototype.addTriplet=function(c,b,a){if(!this.hasIndex){return}this.index.push(c);this.index.push(b);this.index.push(a)};Cube.core.GeometryNode=function(a){Cube.core.Node.call(this,a)};Cube.core.GeometryNode.prototype=new Cube.core.Node({});Cube.core.GeometryNode.prototype.constructor=Cube.core.GeometryNode;Cube.core.GeometryNode.prototype.accept=function(a){a.visitGeometry(this)};Cube.core.MeshNode=function(a){checkGeometry(a.geometry);checkMaterial(a.material);this.geometry=a.geometry;this.material=a.material;this.nodes.push(this.material);this.nodes.push(this.geometry);Cube.core.ArrayNode.call(this,a)};Cube.core.MeshNode.prototype=new Cube.core.ArrayNode({});Cube.core.MeshNode.prototype.constructor=Cube.core.MeshNode;Cube.core.MeshNode.prototype.checkGeometry=function(a){Cube.core.Utilities.checkReference(a);Cube.core.Utilities.checkType(a,Cube.core.GeometryNode);return a};Cube.core.MeshNode.prototype.checkMaterial=function(a){Cube.core.Utilities.checkReference(a);Cube.core.Utilities.checkType(a,Cube.core.MaterialNode);return a};Cube.core.OpticNode=function(a){Cube.core.Node.call(this,a);this.matrix=(new Cube.core.math.Matrix4()).initToIdentity();this.setup(a)};Cube.core.OpticNode.prototype=new Cube.core.Node({});
Cube.core.OpticNode.prototype.constructor=Cube.core.OpticNode;Cube.core.OpticNode.prototype.accept=function(a){a.visitOptic(this)};Cube.core.OpticNode.prototype.setup=function(a){Cube.core.Utilities.checkReference(a);this.fov=a.fov||this.default_fov;this.ratio=a.ratio||this.default_ratio;this.near=a.near||this.default_near;this.far=a.far||this.default_far;this.updateMatrix()};Cube.core.OpticNode.prototype.updateMatrix=function(){var h=this.near*Math.tan(this.fov*0.5);var a=-h;var d=h*this.ratio;var g=-d;var f=2*this.near;var e=1/(d-g);var c=1/(h-a);var b=1/(this.far-this.near);this.matrix.initFromRawData([f*e,0,0,0,0,f*c,0,0,(d+g)*e,(h+a)*c,-(this.far+this.near)*b,-1,0,0,-(this.far*f)*b,0])};Cube.core.OpticNode.prototype.getMatrix=function(){return this.matrix};Cube.core.OpticNode.prototype.default_fov=Math.PI/2;Cube.core.OpticNode.prototype.default_ratio=1;Cube.core.OpticNode.prototype.default_near=1;Cube.core.OpticNode.prototype.default_far=1000;Cube.core.TransformNode=function(a){Cube.core.Node.call(this,a);this.checkParent(a.parent);this.checkMatrix(a.matrix);this.matrix=a.matrix||(new Cube.core.math.Matrix4()).initToIdentity();this.invert=this.matrix.clone().invertToSelf();this.normal=this.invert.clone().transposeToSelf();this.parent=a.parent||null};Cube.core.TransformNode.prototype=new Cube.core.Node({});Cube.core.TransformNode.prototype.constructor=Cube.core.TransformNode;Cube.core.TransformNode.prototype.accept=function(a){a.visitTransform(this)};Cube.core.TransformNode.prototype.getMatrix=function(){return this.matrix};Cube.core.TransformNode.prototype.getInvert=function(){return this.invert};Cube.core.TransformNode.prototype.getNormal=function(){return this.normal};Cube.core.TransformNode.prototype.update=function(){if(this.parent){this.matrix=this.parent.getMatrix().multiply(this.matrix)}this.invert=this.matrix.clone().invertToSelf();this.normal=this.invert.clone().transposeToSelf();return this};Cube.core.TransformNode.prototype.checkMatrix=function(a){if(a){Cube.core.Utilities.checkType(a,Cube.core.math.Matrix4,"matrix should be Cube.core.math.Matrix4")}};Cube.core.TransformNode.prototype.checkParent=function(a){if(a){Cube.core.Utilities.checkType(a,Cube.core.TransformNode,"parent should be Cube.core.TransformNode")}};Cube.core.RotationXYZNode=function(a){Cube.core.TransformNode.call(this,a);this.vector=a.vector;this.update()};Cube.core.RotationXYZNode.prototype=new Cube.core.TransformNode({});Cube.core.RotationXYZNode.prototype.constructor=Cube.core.RotationXYZNode;Cube.core.RotationXYZNode.prototype.set=function(a,c,b){if(!!a){this.vector.setX(a)}if(!!c){this.vector.setY(c)}if(!!b){this.vector.setZ(b)}};Cube.core.RotationXYZNode.prototype.update=function(){var n=this.vector;var l=this.getMatrix();var m=n.x,j=n.y,i=n.z;var e=Math.cos(m),k=Math.sin(m);var d=Math.cos(j),h=Math.sin(j);var c=Math.cos(i),g=Math.sin(i);var f=c*k,a=k*g,b=e*c;l.setElement(0,0,d*c);l.setElement(0,1,d*-g);l.setElement(0,2,h);l.setElement(1,0,f*h+g*e);l.setElement(1,1,a*-h+b);l.setElement(1,2,-k*d);l.setElement(2,0,b*-h+a);l.setElement(2,1,e*h*g+f);l.setElement(2,2,e*d);return Cube.core.TransformNode.prototype.update.call(this)};Cube.core.ScalingNode=function(a){Cube.core.TransformNode.call(this,a);this.vector=a.vector;this.update()};Cube.core.ScalingNode.prototype=new Cube.core.TransformNode({});Cube.core.ScalingNode.prototype.constructor=Cube.core.ScalingNode;Cube.core.RotationXYZNode.prototype.set=function(a,c,b){if(!!a){this.vector.setX(a)}if(!!c){this.vector.setY(c)}if(!!b){this.vector.setZ(b)}};Cube.core.ScalingNode.prototype.update=function(){var b=this.vector;var a=this.getMatrix();a.setElement(0,0,b.x);a.setElement(1,1,b.y);a.setElement(2,2,b.z);return Cube.core.TransformNode.prototype.update.call(this)};Cube.core.TranslationNode=function(a){Cube.core.TransformNode.call(this,a);this.vector=a.vector;this.update()};Cube.core.TranslationNode.prototype=new Cube.core.TransformNode({});Cube.core.TranslationNode.prototype.constructor=Cube.core.TranslationNode;
Cube.core.RotationXYZNode.prototype.set=function(a,c,b){if(!!a){this.vector.setX(a)}if(!!c){this.vector.setY(c)}if(!!b){this.vector.setZ(b)}};Cube.core.TranslationNode.prototype.update=function(){var b=this.vector;var a=this.getMatrix();a.setElement(0,3,b.getX());a.setElement(1,3,b.getY());a.setElement(2,3,b.getZ());return Cube.core.TransformNode.prototype.update.call(this)};Cube.core.TransformStackNode=function(a){Cube.core.TransformNode.call(this,a);this.transformations=new Cube.core.ArrayNode({})};Cube.core.TransformStackNode.prototype=new Cube.core.TransformNode({});Cube.core.TransformStackNode.prototype.constructor=Cube.core.TransformStackNode;Cube.core.TransformStackNode.prototype.push=function(a){Cube.core.Utilities.checkReference(a,"transfo");Cube.core.Utilities.checkType(a,Cube.core.TransformNode,"transfo should be Cube.core.TransformNode");this.transformations.push(a);return this};Cube.core.TransformStackNode.prototype.update=function(){this.transformations.nodes.reduce(function(a,b){b.update();return a.multiplyToSelf(b.getMatrix())},this.matrix.initToIdentity());return Cube.core.TransformNode.prototype.update.call(this)};Cube.core.TransformStackNode.prototype.compact=function(b){var a=this.transformations.nodes.reduce(function(d,e,c){if(c<b){return d}return d.multiplyToSelf(e.getMatrix())},(new Cube.core.math.Matrix4()).initToIdentity());this.transformations.clear(b).push(new Cube.core.TransformNode({matrix:a}));return this};Cube.core.StatePopNode=function(a){Cube.core.Node.call(this,a)};Cube.core.StatePopNode.prototype=new Cube.core.Node({});Cube.core.StatePopNode.prototype.constructor=Cube.core.StatePopNode;Cube.core.StatePopNode.prototype.accept=function(a){a.visitStatePop()};Cube.core.StatePushNode=function(a){Cube.core.Node.call(this,a)};Cube.core.StatePushNode.prototype=new Cube.core.Node({});Cube.core.StatePushNode.prototype.constructor=Cube.core.StatePushNode;Cube.core.StatePushNode.prototype.accept=function(a){a.visitStatePush()};Cube.core.ViewNode=function(a){Cube.core.TransformNode.call(this,a)};Cube.core.ViewNode.prototype=new Cube.core.TransformNode({});Cube.core.ViewNode.prototype.constructor=Cube.core.ViewNode;Cube.core.ViewNode.prototype.accept=function(a){a.visitView(this)};Cube.core.ViewportNode=function(a){Cube.core.Node.call(this,a);this.x=a.x||0;this.y=a.y||0;this.w=a.width;this.h=a.height};Cube.core.ViewportNode.prototype=new Cube.core.Node({});Cube.core.ViewportNode.prototype.constructor=Cube.core.ViewportNode;Cube.core.ViewportNode.prototype.accept=function(a){a.visitViewport(this)};Cube.core.ViewportNode.prototype.getX=function(){return this.x};Cube.core.ViewportNode.prototype.getY=function(){return this.y};Cube.core.ViewportNode.prototype.getWidth=function(){return this.w};Cube.core.ViewportNode.prototype.getHeight=function(){return this.h};Cube.core.GeometryHelpers={buildSphere:function(h,l){var e=20,C=(e+1)*(2*e+1),A=e*2*e;nbTris=A*2,nbIndices=nbTris*3;l.begin(C,nbIndices);var D=-Math.PI/2,G=Math.PI/2,r=(G-D)/e,B=0,g=2*Math.PI,f=(g-B)/(2*e);var E;for(E=0;E<=e;++E){var s=D+E*(G-D)/e,m=Math.sin(s),F=Math.cos(s),o=(1-E/e);var t;for(t=0;t<=2*e;++t){var q=B+t*(g-B)/(2*e),n=Math.cos(q)*F,k=Math.sin(q)*F,p=(1-t/(e*2));l.addVertex(n*h,m*h,k*h);l.addNormal(n,m,k);l.addColor(n,m,k,1)}}var j=0;var w=e*2+1,s;for(s=0;s<e;++s){var i=s*w,q;for(q=0;q<e*2;++q){var d=i+q,c=i+q+1,b=i+w+q,a=i+w+q+1;l.addTriplet(d,b,c);l.addTriplet(c,b,a)}}return l.end()},buildCube:function(b,c){var h=[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1];var e=[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0];var g=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1];var a=[1,1,1,1,1,0,1,0,0,1,0,1,1,1,1,1,0,1,0,0,1,0,1,1,1,1,1,0,1,1,0,1,0,1,1,0,1,1,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,1,0,0,0,0,1,0,0,1,1];
var i=[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20];c.begin(h.length/3,i.length);var j;for(j=0;j<h.length/3;++j){var d=j*3;var f=j*2;c.addVertex(h[d]*b,h[d+1]*b,h[d+2]*b);c.addNormal(g[d],g[d+1],g[d+2]);c.addColor(a[d],a[d+1],a[d+2],1);c.addUV(e[f],e[f+1])}for(iterInd=0;iterInd<i.length/6;++iterInd){var d=iterInd*6;c.addTriplet(i[d],i[d+1],i[d+2]);c.addTriplet(i[d+3],i[d+4],i[d+5])}return c.end()}};Cube.core.ShaderNode=function(a){Cube.core.Node.call(this,a);this.manager=a.manager;this.name=a.name;this.program=null};Cube.core.ShaderNode.prototype=new Cube.core.Node({});Cube.core.ShaderNode.prototype.constructor=Cube.core.ShaderNode;Cube.core.ShaderNode.prototype.getProgram=function(){if(this.program==null){this.program=this.manager.createProgram(this.name)}return this.program};Cube.core.ShaderNode.prototype.getBindings=function(){if(this.program==null){this.program=this.manager.createProgram(this.name)}return this.manager.getBindings(this.name)};Cube.core.ShaderNode.prototype.getParamTypes=function(){return this.manager.getParamTypes(this.name)};Cube.core.ShaderNode.prototype.accept=function(a){a.visitShader(this)};Cube.core.TextureNode=function(a){Cube.core.Node.call(this,a);this.manager=a.manager;this.name=a.name;this.texture=null;this.ready=false};Cube.core.TextureNode.prototype=new Cube.core.Node({});Cube.core.TextureNode.prototype.constructor=Cube.core.TextureNode;Cube.core.TextureNode.prototype.getName=function(){return this.name};Cube.core.TextureNode.prototype.isReady=function(){return this.ready};Cube.core.TextureNode.prototype.getTexture=function(){return this.texture};Cube.core.TextureNode.prototype.accept=function(a){a.visitTexture(this)};Cube.core.ResourceLoader=function(){};Cube.core.ResourceLoader.prototype={};Cube.core.ResourceLoader.prototype.constructor=Cube.core.ResourceLoader;Cube.core.ResourceLoader.prototype.getResource=function(a){return document.getElementById(a).text};Cube.core.ShaderManager=function(a){this.engine=a.engine;this.gl=a.engine.gl;this.loader=a.loader;this.vertexs={};this.fragments={};this.programs={};this.shaders=this.createShaders(a.shaders)};Cube.core.ShaderManager.prototype={};Cube.core.ShaderManager.prototype.constructor=Cube.core.ShaderManager;Cube.core.ShaderManager.prototype.getShader=function(a){return this.shaders[a]};Cube.core.ShaderManager.prototype.getBindings=function(a){return this.programs[a].bindings};Cube.core.ShaderManager.prototype.getParamTypes=function(a){return this.programs[a].params};Cube.core.ShaderManager.prototype.createShaders=function(a){var e={};for(shaderName in a){var f=a[shaderName];var c={verts:[],frags:[],params:f.params,mappings:f.mappings};this.programs[shaderName]=c;for(var d=0;d<f.src.length;++d){var b=f.src[d];if(b.toLowerCase().indexOf("vertex")!=-1){c.verts.push(b)}else{if(b.toLowerCase().indexOf("fragment")!=-1){c.frags.push(b)}else{}}}e[shaderName]=new Cube.core.ShaderNode({manager:this,name:shaderName});if(f.preload){e[shaderName].getProgram()}}return e};Cube.core.ShaderManager.prototype.createVertexShader=function(b){var a=this.createShader(b,this.gl.VERTEX_SHADER);return a};Cube.core.ShaderManager.prototype.createFragmentShader=function(b){var a=this.createShader(b,this.gl.FRAGMENT_SHADER);return a};Cube.core.ShaderManager.prototype.createShader=function(c,a){var b=this.gl.createShader(a);this.gl.shaderSource(b,c);this.gl.compileShader(b);if(!this.gl.getShaderParameter(b,this.gl.COMPILE_STATUS)){var d=this.gl.getShaderInfoLog(b);this.gl.deleteShader(b);throw"Failed to compile shader ["+d+"]"}return b};Cube.core.ShaderManager.prototype.createProgram=function(c){var l=this.programs[c];var f=this.gl.createProgram();for(var e=0;e<l.verts.length;++e){var g=l.verts[e];if(this.vertexs[g]==null){this.vertexs[g]=this.createVertexShader(this.loader.getResource(g))}this.gl.attachShader(f,this.vertexs[g])}for(var e=0;e<l.frags.length;++e){var g=l.frags[e];if(this.fragments[g]==null){this.fragments[g]=this.createFragmentShader(this.loader.getResource(g))
}this.gl.attachShader(f,this.fragments[g])}this.gl.linkProgram(f);var b=this.gl.getProgramParameter(f,this.gl.LINK_STATUS);if(!b){var h=this.gl.getProgramInfoLog(f);this.gl.deleteProgram(f);throw"Error in program linking ["+h+"]"}this.gl.useProgram(f);var k={uniforms:{},attributes:{}};for(var c in this.engine.getRenderer().shaderParameters.uniforms){var j=this.gl.getUniformLocation(f,c);if(!j&&l.mappings){var a=l.mappings.uniforms[c];j=this.gl.getUniformLocation(f,a)}if(j){k.uniforms[c]=j}}for(var c in this.engine.getRenderer().shaderParameters.attributes){var j=this.gl.getAttribLocation(f,c);if(j<0&&l.mappings){var a=l.mappings.attributes[c];j=this.gl.getAttribLocation(f,a)}if(j>=0){k.attributes[c]=j}}for(var d in l.params.uniforms){var j=this.gl.getUniformLocation(f,d);if(j){k.uniforms[d]=j}}l.bindings=k;return f};Cube.core.TextureManager=function(a){this.engine=a.engine;this.gl=a.engine.gl;this.textures={};this.desc={};for(var b in a.desc){var c=a.desc[b];this.desc[b]=c;this.textures[b]=new Cube.core.TextureNode({manager:this,name:b})}};Cube.core.TextureManager.prototype={};Cube.core.TextureManager.prototype.constructor=Cube.core.TextureManager;Cube.core.TextureManager.prototype.getTexture=function(a){var b=this.textures[a];if(!!b&&!b.isReady()){this.loadTexture(b)}return b};Cube.core.TextureManager.prototype.loadTexture=function(c){var b=new Image();var a=this;var e=a.gl;var d=this.desc[c.getName()];b.onload=function(){var h=d.quality==Cube.core.Renderer.prototype.textureQuality.POOR?e.NEAREST:e.LINEAR;var f=d.quality==Cube.core.Renderer.prototype.textureQuality.POOR?e.NEAREST:(d.quality==Cube.core.Renderer.prototype.textureQuality.GOOD?e.LINEAR:e.LINEAR_MIPMAP_NEAREST);var g=e.createTexture();e.bindTexture(e.TEXTURE_2D,g);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,true);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,b);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,h);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,f);if(d.quality==Cube.core.Renderer.prototype.textureQuality.BEST){e.generateMipmap(e.TEXTURE_2D)}e.bindTexture(e.TEXTURE_2D,null);c.texture=g;c.ready=true};b.src=d.res};Cube.core.MaterialBindingNode=function(a){Cube.core.Node.call(this,a);this.name=a.name;this.type=a.type;this.value=a.value};Cube.core.MaterialBindingNode.prototype=new Cube.core.Node({});Cube.core.MaterialBindingNode.prototype.constructor=Cube.core.MaterialBindingNode;Cube.core.MaterialBindingNode.prototype.getParameterName=function(){return this.name};Cube.core.MaterialBindingNode.prototype.getParameterType=function(){return this.type};Cube.core.MaterialBindingNode.prototype.getParameterValue=function(){return this.value};Cube.core.MaterialBindingNode.prototype.accept=function(a){a.visitMaterialBinding(this)};Cube.core.MaterialNode=function(a){Cube.core.Node.call(this,a);this.transparent=a.transparent;this.nodes=new Cube.core.ArrayNode({});this.nodes.push(a.shader);for(var b in a.bindings){var c=new Cube.core.MaterialBindingNode({name:b,type:a.shader.getParamTypes().uniforms[b],value:a.bindings[b]});this.nodes.push(c)}};Cube.core.MaterialNode.prototype=new Cube.core.Node({});Cube.core.MaterialNode.prototype.constructor=Cube.core.MaterialNode;Cube.core.MaterialNode.prototype.isTransparent=function(a){return this.transparent};Cube.core.MaterialNode.prototype.accept=function(a){a.visitMaterial(this);this.nodes.accept(a)};Cube.core.CameraNode=function(a){Cube.core.Node.call(this,a);this.opticNode=a.optic;this.viewNode=new Cube.core.ViewNode({parent:a.parent});this.viewNode.update()};Cube.core.CameraNode.prototype=new Cube.core.Node({});Cube.core.CameraNode.prototype.constructor=Cube.core.CameraNode;Cube.core.CameraNode.prototype.accept=function(a){a.visitOptic(this.opticNode);a.visitView(this.viewNode)};Cube.core.Tree=function(a){checkRoot(a.root);this.root=a.root;Cube.core.Node.call(this,a)};Cube.core.Tree.prototype=new Cube.core.Node({});Cube.core.Tree.prototype.constructor=Cube.core.Tree;Cube.core.Tree.prototype.checkRoot=function(a){checkReference(a);
checkType(a,Cube.core.Node,"root should be Cube.core.Node")};Cube.core.Engine=function(a){var b=a.canvas;var c=b.getContext("experimental-webgl",{alpha:true,antialias:true,stencil:true});if(!c){throw"failed to created WebGL context"}this.canvas=b;this.gl=c;this.renderer=new Cube.core.Renderer({gl:c})};Cube.core.Engine.prototype.constructor=Cube.core.Engine;Cube.core.Engine.prototype.getRenderer=function(){return this.renderer};Cube.core.Renderer=function(a){this.gl=a.gl;this.defaultClearFlags=0;this.mappings=null;this.projectionTransfo=null;this.viewTransfo=null;this.bufferFactoryFunc=null;this.nextTextureUnit=0;this.setup()};Cube.core.Renderer.prototype={};Cube.core.Renderer.prototype.mode={POINT:"point",ELEMENT:"element"};Cube.core.Renderer.prototype.textureQuality={POOR:"poor",GOOD:"good",BEST:"best"};Cube.core.Renderer.prototype.shaderParameters={uniforms:{matrixProjection:"matrixProjection",matrixModel:"matrixModel",matrixNormal:"matrixNormal",matrixView:"matrixView"},attributes:{vertex:"vertex",normal:"normal",color:"color",uv:"uv"}};Cube.core.Renderer.prototype.shaderParameterTypes={FLOAT:"float",VEC4:"vec4",TEXTURE2D:"texture2D"};Cube.core.Renderer.prototype.shaderDefaultParameterTypes={texture0:Cube.core.Renderer.prototype.shaderParameterTypes.texture2D};Cube.core.Renderer.prototype.constructor=Cube.core.Renderer;Cube.core.Renderer.prototype.getBufferFactory=function(){return this.bufferFactoryFunc};Cube.core.Renderer.prototype.setup=function(){this.bufferFactoryFunc=(function(a){return function(d,e){var b=a.createBuffer();var c=d?a.ELEMENT_ARRAY_BUFFER:a.ARRAY_BUFFER;a.bindBuffer(c,b);a.bufferData(c,e,a.STATIC_DRAW);return b}})(this.gl);this.defaultClearFlags=this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT;this.gl.clearColor(0,0,0,1);this.gl.enable(this.gl.DEPTH_TEST);this.gl.enable(this.gl.CULL_FACE)};Cube.core.Renderer.prototype.setTransparentMode=function(a){this.transparentMode=!!a};Cube.core.Renderer.prototype.clear=function(a){var c=0;if(!!a){if(!!a.color){c|=this.gl.COLOR_BUFFER_BIT}if(!!a.depth){c|=this.gl.DEPTH_BUFFER_BIT}if(!!a.stencil){c|=this.gl.STENCIL_BUFFER_BIT}}else{c=this.defaultClearFlags}this.gl.clear(c);for(var b=0;b<this.nextTextureUnit;++b){this.gl.activeTexture(this.gl.TEXTURE0+b);this.gl.bindTexture(this.gl.TEXTURE_2D,null)}this.nextTextureUnit=0};Cube.core.Renderer.prototype.setViewport=function(a,d,b,c){this.gl.viewport(a,d,b,c)};Cube.core.Renderer.prototype.loadMappings=function(a){this.mappings=a;return this};Cube.core.Renderer.prototype.loadProjectionTransformation=function(a){this.projectionTransfo=a};Cube.core.Renderer.prototype.loadViewTransformation=function(a){this.viewTransfo=a};Cube.core.Renderer.prototype.loadNormalTransformation=function(a){var b=a.getRawData();this.gl.uniformMatrix4fv(this.mappings.uniforms[this.shaderParameters.uniforms.matrixNormal],false,b)};Cube.core.Renderer.prototype.loadModelTransformation=function(a){var b=a.getRawData();this.gl.uniformMatrix4fv(this.mappings.uniforms[this.shaderParameters.uniforms.matrixModel],false,b)};Cube.core.Renderer.prototype.renderBufferSet=function(b,a){if(!a.vertexBuffer){return}if(b==this.ELEMENT&&!a.indexBuffer){return}if(!!a.normalBuffer){this.gl.enableVertexAttribArray(this.mappings.attributes[this.shaderParameters.attributes.normal]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.normalBuffer.data);this.gl.vertexAttribPointer(this.mappings.attributes[this.shaderParameters.attributes.normal],3,this.gl.FLOAT,false,0,0)}if(!!a.colorBuffer){this.gl.enableVertexAttribArray(this.mappings.attributes[this.shaderParameters.attributes.color]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.colorBuffer.data);this.gl.vertexAttribPointer(this.mappings.attributes[this.shaderParameters.attributes.color],4,this.gl.FLOAT,false,0,0)}if(!!a.uvBuffer){this.gl.enableVertexAttribArray(this.mappings.attributes[this.shaderParameters.attributes.uv]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.uvBuffer.data);this.gl.vertexAttribPointer(this.mappings.attributes[this.shaderParameters.attributes.uv],2,this.gl.FLOAT,false,0,0)
}this.gl.enableVertexAttribArray(this.mappings.attributes[this.shaderParameters.attributes.vertex]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a.vertexBuffer.data);this.gl.vertexAttribPointer(this.mappings.attributes[this.shaderParameters.attributes.vertex],3,this.gl.FLOAT,false,0,0);if(this.transparentMode){this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.depthMask(false)}if(this.transparentMode){this.gl.frontFace(this.gl.CW);if(b==this.mode.ELEMENT){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a.indexBuffer.data);this.gl.drawElements(this.gl.TRIANGLES,a.indexBuffer.size,this.gl.UNSIGNED_SHORT,0)}else{this.gl.drawArrays(this.gl.POINTS,0,a.vertexBuffer.size/3)}this.gl.frontFace(this.gl.CCW)}if(b==this.mode.ELEMENT){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a.indexBuffer.data);this.gl.drawElements(this.gl.TRIANGLES,a.indexBuffer.size,this.gl.UNSIGNED_SHORT,0)}else{this.gl.drawArrays(this.gl.POINTS,0,a.vertexBuffer.size/3)}this.gl.disable(this.gl.BLEND);this.gl.depthMask(true)};Cube.core.Renderer.prototype.useShader=function(a){this.gl.useProgram(a.getProgram());this.loadMappings(a.getBindings());this.loadPerFrameData()};Cube.core.Renderer.prototype.useTexture=function(a){if(this.mappings.uniforms[this.shaderParameters.uniforms.texture0]){this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,a.getTexture())}};Cube.core.Renderer.prototype.bindShaderParamWithValue=function(a,b,c){var d=this.mappings.uniforms[a];if(!d){return}if(b==this.shaderParameterTypes.FLOAT){this.gl.uniform1f(d,c)}else{if(b==this.shaderParameterTypes.VEC4){this.gl.uniform4fv(d,c)}else{if(b==this.shaderParameterTypes.TEXTURE2D){this.gl.activeTexture(this.gl.TEXTURE0+this.nextTextureUnit);this.gl.bindTexture(this.gl.TEXTURE_2D,c.getTexture());this.gl.uniform1i(d,this.nextTextureUnit);this.nextTextureUnit=this.nextTextureUnit+1}else{}}}};Cube.core.Renderer.prototype.loadPerFrameData=function(){this.gl.uniformMatrix4fv(this.mappings.uniforms[this.shaderParameters.uniforms.matrixProjection],false,this.projectionTransfo.getRawData());this.gl.uniformMatrix4fv(this.mappings.uniforms[this.shaderParameters.uniforms.matrixView],false,this.viewTransfo.getRawData())};